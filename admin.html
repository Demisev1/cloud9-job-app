<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Cloud 9 Vapes — Admin</title>
<link rel="icon" href="assets/logo.png"/>
<style>
:root{
  --bg:#0b0f1a;--panel:#0b1020;--ink:#e5e7eb;--muted:#a6adbb;--line:#1f2937;
  --brand1:#60a5fa;--brand2:#22d3ee;--good:#22c55e;--warn:#f59e0b;--bad:#ef4444;
  --radius:18px
}
*{box-sizing:border-box}
body{margin:0;background:var(--bg);color:var(--ink);font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial}
header{position:sticky;top:0;height:64px;display:flex;align-items:center;gap:12px;padding:0 20px;border-bottom:1px solid #111827;background:rgba(10,14,24,.78);backdrop-filter:saturate(140%) blur(6px);z-index:10}
.brand{display:flex;align-items:center;gap:10px;font-weight:700}
.brand img{height:36px;width:auto;border-radius:10px}
nav{margin-left:auto;display:flex;gap:10px}
.btn{display:inline-flex;align-items:center;justify-content:center;padding:10px 14px;border-radius:12px;border:1px solid var(--line);text-decoration:none;color:var(--ink);cursor:pointer;background:transparent;transition:.15s}
.btn:hover{border-color:#2b3a55;transform:translateY(-1px)}
.btn.primary{background:linear-gradient(90deg,var(--brand1),var(--brand2));color:#051126;border:none;font-weight:800}
.btn.danger{border-color:#5b1f23;color:#fee2e2}
.container{max-width:1220px;margin:24px auto;padding:0 16px;display:grid;grid-template-columns:1fr 340px;gap:16px}
.card{background:radial-gradient(900px 360px at 15% -10%,rgba(34,211,238,.08),transparent),var(--panel);border:1px solid rgba(255,255,255,.06);border-radius:var(--radius);padding:18px;box-shadow:0 12px 30px rgba(0,0,0,.3)}
.controls{display:flex;gap:10px;flex-wrap:wrap;margin-bottom:12px}
input,select,textarea{padding:10px;border-radius:12px;border:1px solid var(--line);background:#0a1222;color:#e5e7eb}
.table{width:100%;border-collapse:separate;border-spacing:0 8px}
.table thead th{font-size:13px;color:#a5f3fc;padding:8px 10px;border-bottom:1px solid #162034;text-align:left}
.table tbody tr{background:#0b1222;border:1px solid #131e33;border-radius:14px}
.table td{padding:12px 10px;vertical-align:top;border-top:1px solid #131e33}
.table tbody tr:first-child td{border-top:none}
.badge{padding:4px 8px;border-radius:10px;background:#1f2937}
.badge.pending_review{background:#343b48}
.badge.interview{background:#1e40af}
.badge.hired{background:#14532d}
.badge.rejected{background:#7f1d1d}
.mono{font-family:ui-monospace, SFMono-Regular, Menlo, monospace;color:#cbd5e1;font-size:12px}
.actions{display:flex;gap:8px;flex-wrap:wrap}
a.link{color:#93c5fd;text-decoration:none}
a.link:hover{text-decoration:underline}
/* Right rail: store manager */
.rail h3{margin:0 0 8px 0}
.divider{height:1px;background:#152238;margin:12px 0}
.store-item{display:flex;align-items:center;justify-content:space-between;padding:8px 10px;border:1px solid #18243a;border-radius:12px;margin-bottom:8px}
small{color:#99a3b2}
/* Modal */
.modal{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;z-index:50}
.modal .box{background:var(--panel);border:1px solid rgba(255,255,255,.08);border-radius:16px;padding:16px;max-width:520px;width:92%}
.modal h3{margin:0 0 10px 0}
.row{display:flex;gap:10px;flex-wrap:wrap}
.row > *{flex:1}
.note{font-size:13px;color:#c7d2fe;background:#0b1028;border:1px solid #24304a;border-radius:10px;padding:10px;margin-top:6px}
.center{min-height:50vh;display:grid;place-items:center}
label{font-size:13px;color:#cbd5e1}
.small{color:#9ca3af;font-size:12px}

/* --- Auth gate: hide everything until signed in --- */
body.locked #appShell{display:none !important;}

</style>
</head>
<body class="locked">
<div id="appShell">
<header>
  <div class="brand"><img src="assets/logo.png" alt="Cloud 9 Vapes Logo"/><span>Cloud 9 Vapes — Admin</span></div>
  <nav>
    <a class="btn" href="index.html">Home</a>
    <a class="btn" href="apply.html">Apply</a>
    <button id="logoutBtn" class="btn">Logout</button>
  </nav>
</header>

<div class="container">
  <!-- Main dashboard -->
  <div class="card">
    <div class="controls">
      <select id="filterLocation"><option value="">All locations</option></select>
      <select id="filterStatus">
        <option value="">All statuses</option>
        <option value="pending_review">Pending review</option>
        <option value="interview">Interview</option>
        <option value="hired">Hired</option>
        <option value="rejected">Rejected</option>
      </select>
      <input id="search" placeholder="Search name / email / phone" style="min-width:260px"/>
      <button id="refreshBtn" class="btn">Refresh</button>
    </div>

    <table class="table" id="appsTable">
      <thead>
        <tr>
          <th>Applied</th>
          <th>Name</th>
          <th>Email</th>
          <th>Phone</th>
          <th>Location</th>
          <th>Hours</th>
          <th>Start</th>
          <th>Status</th>
          <th>About</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <!-- Right rail: Store manager & quick actions -->
  <aside class="card rail">
    <h3>Store manager</h3>
    <div class="small">Add or toggle visibility of locations.</div>
    <div class="divider"></div>
    <div class="row">
      <div>
        <label>Store name</label>
        <input id="storeName" placeholder="e.g. Hillcrest - 24/7"/>
      </div>
      <div>
        <label>Display order</label>
        <input id="storeOrder" type="number" value="1"/>
      </div>
    </div>
    <div style="display:flex;gap:8px;margin-top:8px">
      <button id="addStoreBtn" class="btn primary" style="flex:1">Add Store</button>
      <button id="reloadStoresBtn" class="btn" style="flex:1">Reload</button>
    </div>
    <div class="divider"></div>
    <div id="storesList"></div>
    <div class="divider"></div>
    <div>
      <h3>Help</h3>
      <small>Click <em>Edit</em> to change status or add a public note. Click <em>View</em> to read the full “About”.</small>
    </div>
  </aside>
</div>

<!-- Edit modal -->
<div class="modal" id="editModal">
  <div class="box">
    <h3>Edit Application</h3>
    <div class="row">
      <div>
        <label>Status</label><br/>
        <select id="statusSelect">
          <option value="pending_review">Pending review</option>
          <option value="interview">Interview</option>
          <option value="hired">Hired</option>
          <option value="rejected">Rejected</option>
        </select>
      </div>
      <div>
        <label>Public note (visible to applicant)</label><br/>
        <textarea id="noteInput" placeholder="Optional note..."></textarea>
      </div>
    </div>
    <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px">
      <button class="btn primary" id="saveBtn">Save</button>
      <button class="btn" id="cancelBtn">Cancel</button>
    </div>
  </div>
</div>

<!-- About modal -->
<div class="modal" id="aboutModal">
  <div class="box">
    <h3>About Applicant</h3>
    <div id="aboutContent" class="note"></div>
    <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px">
      <button class="btn" id="aboutCloseBtn">Close</button>
    </div>
  </div>
</div>

<!-- Sign-in overlay -->
<div class="modal" id="authModal" style="background:rgba(0,0,0,.72);display:flex">
  <div class="box" style="max-width:460px">
    <h3>Admin Sign In</h3>
    <p class="small">Use your admin email & password.</p>
    <label>Email</label>
    <input id="adminEmail" type="email" placeholder="you@company.com" style="width:100%;margin-bottom:8px"/>
    <label>Password</label>
    <input id="adminPass" type="password" placeholder="••••••••" style="width:100%;margin-bottom:12px"/>
    <div style="display:flex;gap:8px">
      <button id="signinBtn" class="btn primary" style="flex:1">Sign in</button>
      <button id="signupBtn" class="btn" style="flex:1">Create admin</button>
    </div>
    <p id="signinMsg" class="mono" style="margin-top:10px;opacity:.9"></p>
  </div>
</div>

<script type="module">
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm";
import { SUPABASE_URL, SUPABASE_ANON } from "./js/config.js";
const sb = createClient(SUPABASE_URL, SUPABASE_ANON);

// Allowed admin emails
const ALLOW = ["shane1661@gmail.com"];

// Auth elements
const authModal = document.getElementById("authModal");
const adminEmail = document.getElementById("adminEmail");
const adminPass  = document.getElementById("adminPass");
const signinBtn  = document.getElementById("signinBtn");
const signupBtn  = document.getElementById("signupBtn");
const signinMsg  = document.getElementById("signinMsg");
const logoutBtn  = document.getElementById("logoutBtn");

function __hideAuth(){ authModal.style.display='none'; }
function __showAuth(){ authModal.style.display='flex'; }

signinBtn.onclick = async () => {
  const email=(adminEmail.value||'').trim().toLowerCase();
  const password=adminPass.value||'';
  if(!email||!password){ signinMsg.textContent="Enter email and password."; return; }
  if(!ALLOW.includes(email)){ signinMsg.textContent="You are not authorized for admin."; return; }
  const { error } = await sb.auth.signInWithPassword({ email, password });
  signinMsg.textContent = error ? ("Error: " + error.message) : "Signed in.";
  if(!error) __hideAuth(), init();
};

signupBtn.onclick = async () => {
  const email=(adminEmail.value||'').trim().toLowerCase();
  const password=adminPass.value||'';
  if(!email||!password){ signinMsg.textContent="Enter email and password."; return; }
  if(!ALLOW.includes(email)){ signinMsg.textContent="Not allowed to create admin for this email."; return; }
  const { error } = await sb.auth.signUp({ email, password });
  signinMsg.textContent = error ? ("Error: " + error.message) : "Admin created. Now sign in.";
};

logoutBtn.onclick = async ()=>{
  await sb.auth.signOut();
  ____showAuth();
};

async function gate(){
  const { data:{ user } } = await sb.auth.getUser();
  if(!user || !user.email || !ALLOW.includes(user.email.toLowerCase())){
    ____showAuth(); return null;
  }
  __hideAuth(); return user;
} } = await sb.auth.getUser();
  if(!user || !user.email || !ALLOW.includes(user.email.toLowerCase())){
    ____showAuth(); return null;
  }
  __hideAuth(); return user;
}

// ---------- Dashboard code ----------
const tbody = document.querySelector("#appsTable tbody");
const filterLocation = document.getElementById("filterLocation");
const filterStatus = document.getElementById("filterStatus");
const search = document.getElementById("search");
const refreshBtn = document.getElementById("refreshBtn");

const editModal = document.getElementById("editModal");
const statusSelect = document.getElementById("statusSelect");
const noteInput = document.getElementById("noteInput");
const saveBtn = document.getElementById("saveBtn");
const cancelBtn = document.getElementById("cancelBtn");

const aboutModal = document.getElementById("aboutModal");
const aboutContent = document.getElementById("aboutContent");
const aboutCloseBtn = document.getElementById("aboutCloseBtn");

const storeName = document.getElementById("storeName");
const storeOrder = document.getElementById("storeOrder");
const addStoreBtn = document.getElementById("addStoreBtn");
const reloadStoresBtn = document.getElementById("reloadStoresBtn");
const storesList = document.getElementById("storesList");

let rows = [];
let editingId = null;

function openModal(m){ m.style.display='flex'; document.body.style.overflow='hidden'; }
function closeModal(m){ m.style.display='none'; document.body.style.overflow='auto'; }

cancelBtn.onclick = ()=> closeModal(editModal);
aboutCloseBtn.onclick = ()=> closeModal(aboutModal);

addStoreBtn.onclick = async ()=>{
  const name=(storeName.value||'').trim();
  const display_order=Number(storeOrder.value||'1');
  if(!name){ alert("Enter a store name"); return; }
  const { error } = await sb.from("stores").insert({ name, display_order, is_active: true });
  if(error) { alert(error.message); return; }
  storeName.value=""; storeOrder.value="1";
  await loadStores(); await loadFilters();
};

reloadStoresBtn.onclick = async ()=>{ await loadStores(); };

async function loadStores(){
  const { data, error } = await sb.from("stores").select("*").order("display_order",{ascending:true});
  storesList.innerHTML = '';
  if(error){ storesList.innerHTML = `<div class='small'>${error.message}</div>`; return; }
  (data||[]).forEach(s=>{
    const div=document.createElement('div');
    div.className='store-item';
    div.innerHTML = `<div><strong>${s.name}</strong><br/><small>Order ${s.display_order} • ${s.is_active ? 'Active' : 'Hidden'}</small></div>
      <div style="display:flex;gap:6px">
        <button class="btn" data-toggle="${s.id}">${s.is_active?'Hide':'Show'}</button>
        <button class="btn danger" data-del="${s.id}">Delete</button>
      </div>`;
    storesList.appendChild(div);
  });
  storesList.querySelectorAll("[data-toggle]").forEach(b=>{
    b.onclick = async ()=>{
      const id = b.getAttribute("data-toggle");
      const row = (await sb.from("stores").select("is_active").eq("id",id).single()).data;
      const { error } = await sb.from("stores").update({ is_active: !row.is_active }).eq("id", id);
      if(error) alert(error.message); else loadStores();
    };
  });
  storesList.querySelectorAll("[data-del]").forEach(b=>{
    b.onclick = async ()=>{
      const id = b.getAttribute("data-del");
      if(!confirm("Delete this store?")) return;
      const { error } = await sb.from("stores").delete().eq("id", id);
      if(error) alert(error.message); else { await loadStores(); await loadFilters(); }
    };
  });
}

function sanitize(text){
  return (text||"").replace(/[<>&]/g, s => ({'<':'&lt;','>':'&gt;','&':'&amp;'}[s]));
}
function matchesSearch(r, q){
  if(!q) return true;
  q=q.toLowerCase();
  return (r.first_name||'').toLowerCase().includes(q)
      || (r.last_name||'').toLowerCase().includes(q)
      || (r.email||'').toLowerCase().includes(q)
      || (r.phone||'').toLowerCase().includes(q);
}

async function loadFilters(){
  const { data:stores } = await sb.from("stores").select("name").eq("is_active", true).order("display_order", {ascending:true});
  const current=filterLocation.value;
  filterLocation.innerHTML = '<option value="">All locations</option>' + (stores||[]).map(s=>`<option>${s.name}</option>`).join('');
  filterLocation.value = current || "";
}

async function loadData(){
  const user = await gate(); if(!user) return;
  let query = sb.from("applications").select("*").order("created_at",{ascending:false}).limit(500);
  if(filterLocation.value) query = query.eq("location", filterLocation.value);
  if(filterStatus.value) query = query.eq("status", filterStatus.value);
  const { data, error } = await query;
  if(error){ tbody.innerHTML = `<tr><td colspan="10">${error.message}</td></tr>`; return; }
  rows = (data||[]).filter(r=>matchesSearch(r, search.value));
  render();
}

function render(){
  tbody.innerHTML='';
  rows.forEach(r=>{
    const tr=document.createElement('tr');
    const applied=r.applied_on?new Date(r.applied_on).toLocaleDateString():(r.created_at?new Date(r.created_at).toLocaleDateString():"");
    const start=r.start_date?new Date(r.start_date).toLocaleDateString():"—";
    const aboutShort=sanitize((r.about||"").slice(0,80))+((r.about||"").length>80?"…":"");
    tr.innerHTML = `
      <td class="mono">${applied}</td>
      <td>${sanitize(r.first_name)} ${sanitize(r.last_name)}</td>
      <td><a class="link" href="mailto:${sanitize(r.email)}">${sanitize(r.email)}</a></td>
      <td>${sanitize(r.phone||"")}</td>
      <td>${sanitize(r.location||"")}</td>
      <td>${sanitize(r.hours||"")}</td>
      <td class="mono">${start}</td>
      <td><span class="badge ${sanitize(r.status||"")}">${sanitize(r.status||"")}</span></td>
      <td>${aboutShort ? aboutShort : "<span class='mono' style='opacity:.7'>—</span>"} ${(r.about||"").length>0 ? '<a href="#" class="link" data-about="'+r.id+'">View</a>' : ''}</td>
      <td class="actions">
        <button class="btn" data-edit="${r.id}">Edit</button>
        <button class="btn danger" data-del="${r.id}">Delete</button>
      </td>`;
    tbody.appendChild(tr);
  });

  tbody.querySelectorAll("[data-edit]").forEach(b=>{
    b.onclick = ()=>{
      const id=b.getAttribute("data-edit");
      const r=rows.find(x=>String(x.id)===String(id)); if(!r) return;
      editingId=r.id; statusSelect.value=r.status||"pending_review"; noteInput.value=r.notes||"";
      openModal(editModal);
    };
  });
  tbody.querySelectorAll("[data-del]").forEach(b=>{
    b.onclick = async ()=>{
      const id=b.getAttribute("data-del");
      if(!confirm("Delete this application?")) return;
      const { error } = await sb.from("applications").delete().eq("id", id);
      if(error) alert(error.message); else loadData();
    };
  });
  tbody.querySelectorAll("[data-about]").forEach(a=>{
    a.onclick = (e)=>{
      e.preventDefault();
      const id=a.getAttribute("data-about");
      const r=rows.find(x=>String(x.id)===String(id));
      aboutContent.innerHTML = sanitize(r?.about||"").replace(/\n/g,"<br/>");
      openModal(aboutModal);
    };
  });
}

saveBtn.onclick = async ()=>{
  if(editingId==null) return;
  const patch={ status: statusSelect.value, notes: noteInput.value };
  const { error } = await sb.from("applications").update(patch).eq("id", editingId);
  if(error){ alert(error.message); return; }
  closeModal(editModal); await loadData();
};

filterLocation.onchange = loadData;
filterStatus.onchange = loadData;
search.oninput = ()=>render();
refreshBtn.onclick = async ()=>{ await loadFilters(); await loadData(); };

async function init(){
  await loadStores();
  await loadFilters();
  await loadData();
}
await gate(); await init();

// --- Gate helpers: hide UI until authorized ---
function ____showAuth(){ document.body.classList.add('locked'); const m=document.getElementById('authModal'); if(m) m.style.display='flex'; }
function ____hideAuth(){ document.body.classList.remove('locked'); const m=document.getElementById('authModal'); if(m) m.style.display='none'; }


// Defensive: ensure auth modal exists and is visible when locked
(function(){
  function ensureAuthModal(){
    var m = document.getElementById('authModal');
    if(!m){
      var d=document.createElement('div');
      d.innerHTML = ` <!-- Hard-safe Auth Modal --> <div id="authModal" style="position:fixed;inset:0;background:rgba(0,0,0,.80);display:flex;align-items:center;justify-content:center;z-index:10000">   <div class="card" style="max-width:460px;width:92%">     <h3>Admin Sign In</h3>     <p class="small">Use your admin email & password.</p>     <label>Email</label>     <input id="adminEmail" type="email" placeholder="you@company.com" style="width:100%;margin-bottom:8px"/>     <label>Password</label>     <input id="adminPass" type="password" placeholder="••••••••" style="width:100%;margin-bottom:12px"/>     <div style="display:flex;gap:8px">       <button id="signinBtn" class="btn primary" style="flex:1">Sign in</button>       <button id="signupBtn" class="btn" style="flex:1">Create admin</button>     </div>     <p id="signinMsg" class="mono" style="margin-top:10px;opacity:.9"></p>   </div> </div> `.trim();
      document.body.appendChild(d.firstElementChild);
    }else{
      m.style.display = 'flex';
    }
  }
  if(document.readyState === 'loading'){
    document.addEventListener('DOMContentLoaded', ensureAuthModal);
  } else {
    ensureAuthModal();
  }
})();

</script>
</div>
</body>
</html>