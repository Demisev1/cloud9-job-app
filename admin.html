<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Admin — Cloud 9 Vapes</title>
  <style>
    :root { --bg:#0b0f1a; --card:#111827; --text:#e5e7eb; --muted:#9ca3af; --line:#1f2937; }
    *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--text);font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial}
    header{display:flex;gap:12px;align-items:center;padding:16px 20px;border-bottom:1px solid var(--line)}
    header img{height:44px}
    .container{max-width:1200px;margin:24px auto;padding:0 16px}
    .card{background:#0b1020;border:1px solid rgba(255,255,255,.06);border-radius:14px;padding:18px;margin-bottom:16px}
    input,select,button{padding:10px 12px;border-radius:10px;border:1px solid var(--line);background:#0b1020;color:var(--text)}
    button{cursor:pointer}
    .primary{background:linear-gradient(90deg,#60a5fa,#22d3ee);color:#081020;border:none;font-weight:700}
    .danger{background:#7f1d1d;border:none;color:#fff}
    .hidden{display:none}
    table{width:100%;border-collapse:collapse;margin-top:12px}
    th,td{border-bottom:1px solid var(--line);padding:10px;text-align:left;vertical-align:middle}
    .badge{padding:4px 8px;border-radius:8px;background:#1f2937}
    #editModal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.6);align-items:center;justify-content:center}
    #editModal .box{background:#111827;border:1px solid #243040;border-radius:14px;padding:16px;width:320px}
  </style>
</head>
<body>
<header>
  <img src="assets/logo.png" alt="Cloud 9 Vapes Logo">
  <h1>Admin — Applications</h1>
</header>

<div class="container" id="loginView">
  <div class="card" style="max-width:380px">
    <h2>Sign in</h2>
    <div style="display:grid;gap:10px">
      <input id="adminEmail" type="email" placeholder="Admin email"/>
      <input id="adminPass" type="password" placeholder="Password"/>
      <button id="loginBtn" class="primary">Login</button>
      <p id="loginMsg" style="color:#fca5a5"></p>
    </div>
  </div>
</div>

<div class="container hidden" id="adminView">
  <div class="card">
    <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap">
      <strong>Applications Overview</strong>
      <span id="rowCount" style="margin-left:auto;opacity:.8"></span>
      <button id="logoutBtn">Logout</button>
    </div>
    <div style="display:flex;gap:10px;margin:10px 0">
      <label for="locFilter" style="min-width:120px;opacity:.85">Filter by location</label>
      <select id="locFilter"></select>
    </div>

    <table>
      <thead>
        <tr>
          <th>Submitted</th><th>Name</th><th>Email</th><th>Phone</th><th>Location</th><th>Hours</th><th>Status</th><th>Actions</th>
        </tr>
      </thead>
      <tbody id="appBody"></tbody>
    </table>
  </div>

  <div class="card">
    <h2>Manage Stores</h2>
    <form id="addStoreForm" style="display:flex;gap:10px;flex-wrap:wrap">
      <input id="storeName" placeholder="New store name" required/>
      <input id="storeOrder" type="number" placeholder="Display order (optional)"/>
      <button class="primary" type="submit">Add Store</button>
    </form>
    <table>
      <thead><tr><th>Order</th><th>Name</th><th>Status</th><th>Actions</th></tr></thead>
      <tbody id="storesBody"></tbody>
    </table>
  </div>
</div>

<div id="editModal">
  <div class="box">
    <h3>Edit Status</h3>
    <select id="statusSelect">
      <option value="pending_review">Pending Review</option>
      <option value="interview">Interview</option>
      <option value="hired">Hired</option>
      <option value="rejected">Rejected</option>
    </select>
    <div style="display:flex;gap:10px;justify-content:flex-end;margin-top:12px">
      <button id="saveStatus" class="primary">Save</button>
      <button id="cancelEdit">Cancel</button>
    </div>
  </div>
</div>

<script type="module">
import { sb } from "./js/supabase.js";

const email=document.getElementById('adminEmail');
const pass=document.getElementById('adminPass');
const loginBtn=document.getElementById('loginBtn');
const loginMsg=document.getElementById('loginMsg');

const loginView=document.getElementById('loginView');
const adminView=document.getElementById('adminView');
const logoutBtn=document.getElementById('logoutBtn');

const tbody=document.getElementById('appBody');
const locFilter=document.getElementById('locFilter');
const rowCount=document.getElementById('rowCount');

const modal=document.getElementById('editModal');
const statusSelect=document.getElementById('statusSelect');
const saveStatus=document.getElementById('saveStatus');
const cancelEdit=document.getElementById('cancelEdit');

// Stores
const addStoreForm=document.getElementById('addStoreForm');
const storeName=document.getElementById('storeName');
const storeOrder=document.getElementById('storeOrder');
const storesBody=document.getElementById('storesBody');

let currentRow=null;

function show(el){ el.classList.remove('hidden'); }
function hide(el){ el.classList.add('hidden'); }
function openModal(){ modal.style.display='flex'; document.body.style.overflow='hidden'; }
function closeModal(){ modal.style.display='none'; document.body.style.overflow='auto'; }

loginBtn.onclick = async () => {
  loginMsg.textContent='';
  const { error } = await sb.auth.signInWithPassword({ email: email.value, password: pass.value });
  if(error){ loginMsg.textContent = error.message; return; }
  hide(loginView); show(adminView);
  await Promise.all([loadStores(), loadTable()]);
};

logoutBtn.onclick = async () => {
  await sb.auth.signOut();
  hide(adminView); show(loginView);
};

async function loadStores(){
  const { data, error } = await sb.from('stores').select('*').order('display_order',{ascending:true}).order('name',{ascending:true});
  if(error){ alert(error.message); return; }
  locFilter.innerHTML = '<option value="">All Locations</option>' + (data||[]).map(s=>`<option>${s.name}</option>`).join('');
  storesBody.innerHTML='';
  (data||[]).forEach(s=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${s.display_order ?? ''}</td><td>${s.name}</td><td>${s.is_active?'Active':'Hidden'}</td>
    <td style="display:flex;gap:8px">
      <button class="toggleBtn">${s.is_active?'Hide':'Activate'}</button>
      <button class="delStore danger">Delete</button>
    </td>`;
    tr.querySelector('.toggleBtn').onclick = async ()=>{
      const { error } = await sb.from('stores').update({ is_active: !s.is_active }).eq('id', s.id);
      if(error){ alert(error.message); return; }
      await loadStores();
    };
    tr.querySelector('.delStore').onclick = async ()=>{
      if(!confirm('Delete this store? Existing applications keep their location text.')) return;
      const { error } = await sb.from('stores').delete().eq('id', s.id);
      if(error){ alert(error.message); return; }
      await loadStores();
    };
    storesBody.appendChild(tr);
  });
}

async function loadTable(filterLoc=''){
  let q = sb.from('applications').select('*').order('created_at', { ascending:false });
  if(filterLoc) q = q.eq('location', filterLoc);
  const { data, error } = await q;
  if(error){ alert(error.message); return; }
  renderTable(data||[]);
}

function renderTable(rows){
  tbody.innerHTML='';
  rows.forEach((a)=>{
    const tr=document.createElement('tr');
    const dateStr = a.created_at ? new Date(a.created_at).toLocaleString() : '';
    tr.innerHTML = `
      <td>${dateStr}</td>
      <td>${a.first_name||''} ${a.last_name||''}</td>
      <td>${a.email||''}</td>
      <td>${a.phone||''}</td>
      <td>${a.location||''}</td>
      <td>${a.hours||''}</td>
      <td><span class='badge'>${a.status||''}</span></td>
      <td style="display:flex;gap:8px">
        <button class='editBtn'>Edit</button>
        <button class='delBtn danger'>Delete</button>
      </td>`;
    tr.querySelector('.editBtn').onclick = () => { currentRow=a; statusSelect.value=a.status||'pending_review'; openModal(); };
    tr.querySelector('.delBtn').onclick = async () => {
      if(!confirm('Delete this application? This cannot be undone.')) return;
      const { error } = await sb.from('applications').delete().eq('id', a.id);
      if(error){ alert(error.message); return; }
      await loadTable(locFilter?.value||'');
    };
    tbody.appendChild(tr);
  });
  if(rowCount) rowCount.textContent = `${rows.length} ${rows.length===1?'result':'results'}`;
}

if(locFilter) locFilter.addEventListener('change', ()=> loadTable(locFilter.value||''));
cancelEdit.onclick = closeModal;

saveStatus.onclick = async () => {
  if(!currentRow) return;
  const { error } = await sb.from('applications').update({ status: statusSelect.value }).eq('id', currentRow.id);
  if(error){ alert(error.message); return; }
  closeModal();
  await loadTable(locFilter?.value||'');
};

addStoreForm.addEventListener('submit', async (e)=>{
  e.preventDefault();
  const name = storeName.value.trim();
  const order = storeOrder.value ? parseInt(storeOrder.value,10): null;
  if(!name) return;
  const { error } = await sb.from('stores').insert({ name, display_order: order, is_active: true });
  if(error){ alert(error.message); return; }
  storeName.value=''; storeOrder.value='';
  await loadStores();
});

document.addEventListener('keydown', (e)=>{ if(e.key==='Escape') closeModal(); });
</script>
</body>
</html>
